"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),TicketModel_1=tslib_1.__importDefault(require("../../models/TicketModel")),Command_1=require("../../structures/Command"),parseStyle_1=tslib_1.__importDefault(require("../../helpers/parseStyle")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll"));exports.default=new Command_1.Command({name:"open",description:"Open a ticket",run:({interaction:e,client:s})=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){if(e.channel.type!==discord_js_1.ChannelType.GuildText)return;const t=yield TicketModel_1.default.findOne({guildId:e.guildId,channelId:e.channelId});if(!t)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.ChannelIsNotATicketEmbed)]});if(!t.isClosed)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.TicketIsNotClosed)]});for(const s of t.usersInTicket)yield e.channel.permissionOverwrites.edit(s,{ViewChannel:!0}).catch((e=>e));yield e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.TicketOpenedEmbed,{"{user-tag}":e.user.tag})]}),t.isClosed=!1,yield t.save();const l=yield e.channel.messages.fetch(t.messageControl);l&&(yield l.delete());return(yield e.channel.messages.fetchPinned()).first().edit({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketClose.Emoji).setLabel(s.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketClose.Style)).setCustomId("tka-close").setDisabled(!1),(new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketClaim.Emoji).setLabel(s.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim").setDisabled(t.isClaimed))]})}))});