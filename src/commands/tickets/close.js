"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),TicketModel_1=tslib_1.__importDefault(require("../../models/TicketModel")),Command_1=require("../../structures/Command"),parseStyle_1=tslib_1.__importDefault(require("../../helpers/parseStyle")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll"));exports.default=new Command_1.Command({name:"close",description:"Close a ticket",run:({interaction:e,client:s})=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){if(e.channel.type!==discord_js_1.ChannelType.GuildText)return;const t=yield TicketModel_1.default.findOne({guildId:e.guildId,channelId:e.channelId});if(!t)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.ChannelIsNotATicketEmbed)]});if(t.isClosed)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.TicketAlreadyClosed)]});for(const s of t.usersInTicket)yield e.channel.permissionOverwrites.edit(s,{ViewChannel:!1});const l=yield e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.TicketClosedEmbed,{"{user}":e.user.toString(),"{user-id}":e.user.id,"{user-tag}":e.user.tag})],components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketTranscript.Emoji).setLabel(s.messages.Buttons.TicketTranscript.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketTranscript.Style)).setCustomId("tka-transcript"),(new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketOpen.Emoji).setLabel(s.messages.Buttons.TicketOpen.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketOpen.Style)).setCustomId("tka-open"),(new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketDelete.Emoji).setLabel(s.messages.Buttons.TicketDelete.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketDelete.Style)).setCustomId("tka-delete"))],fetchReply:!0});t.messageControl=l.id,t.isClosed=!0,yield t.save(),(yield e.channel.messages.fetchPinned()).first().edit({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketClose.Emoji).setLabel(s.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketClose.Style)).setCustomId("tka-close").setDisabled(!0),(new discord_js_1.ButtonBuilder).setEmoji(s.messages.Buttons.TicketClaim.Emoji).setLabel(s.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(s.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim").setDisabled(t.isClaimed))]})}))});