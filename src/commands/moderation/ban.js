"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),pagination_1=tslib_1.__importDefault(require("../../helpers/pagination")),PunishModel_1=tslib_1.__importDefault(require("../../models/PunishModel")),Command_1=require("../../structures/Command"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll"));exports.default=new Command_1.Command({name:"ban",description:"Ban's manager",options:[{name:"add",description:"Adds a ban to a member",type:discord_js_1.ApplicationCommandOptionType.Subcommand,options:[{name:"member",description:"The member to ban",type:discord_js_1.ApplicationCommandOptionType.User,required:!0},{name:"reason",description:"The reason for the ban",type:discord_js_1.ApplicationCommandOptionType.String,required:!0},{name:"duration",description:"Number of days of messages to delete (1-7)",type:discord_js_1.ApplicationCommandOptionType.Integer,minValue:1,maxValue:7,required:!1}]},{name:"remove",description:"Removes a ban from a member",type:discord_js_1.ApplicationCommandOptionType.Subcommand,options:[{name:"case",description:"The case/userId to remove and unban",type:discord_js_1.ApplicationCommandOptionType.String,required:!0},{name:"reason",description:"The reason for the ban removal",type:discord_js_1.ApplicationCommandOptionType.String,required:!0}]},{name:"list",description:"Lists all bans for a member or all members",type:discord_js_1.ApplicationCommandOptionType.Subcommand,options:[{name:"member",description:"The member to list bans for",type:discord_js_1.ApplicationCommandOptionType.User}]}],run:({interaction:e,client:s})=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var a,d,r,n;const i=e.options.getString("reason")||"No reason.",t=e.options.getUser("member"),o=yield PunishModel_1.default.findOne({guildId:e.guildId}),l=(null==o?void 0:o.bans)||[],m=e.options.getSubcommand(!1);if("add"===m){const a=e.options.getInteger("duration");if(!e.memberPermissions.has("BanMembers"))return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanBotEmbed)]});if(t.id===s.user.id)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanBotEmbed)]});const d=e.guild.members.cache.get(t.id);if(d&&e.member.roles.highest.position<=d.roles.highest.position)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanBotEmbed)]});if(d&&!d.bannable)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanBotEmbed)]});const r=(null==o?void 0:o.cases)+1||1,n=s=>({userId:t.id,reason:i,date:new Date,moderator:e.member.id,caseNumber:s,removeReason:null});if(o){const s=[...l,n(r)];yield PunishModel_1.default.updateOne({guildId:e.guildId},{$set:{bans:s,cases:r}})}else yield PunishModel_1.default.create({guildId:e.guildId,bans:[n(1)],cases:1});yield e.guild.members.ban(t,{reason:`${e.user.tag} : ${i}`,deleteMessageSeconds:a}).catch((a=>e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanFailedEmbed,{"{error}":a})]}))),yield e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanSuccessfullyEmbed,{"{case}":r,"{member-id}":t.id,"{member-tag}":t.tag,"{reason}":i})]})}if("remove"===m){const a=parseInt(e.options.getString("case")),d=l.find((e=>(null==e?void 0:e.caseNumber)===a)),r=l.map((e=>((null==e?void 0:e.caseNumber)===a&&(e.removeReason=i),e)));if(!d){const a=yield e.guild.members.unban(e.options.getString("case"),`${e.user.tag} : ${i}`).catch((()=>{e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanRemovalFailedEmbed,{"{case}":e.options.getString("case")})]})}));if(!a)return;return yield PunishModel_1.default.updateOne({guildId:e.guildId},{$set:{bans:r}}),e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanRemovalSuccessfullyEmbed,{"{member-id}":a.id,"{member-tag}":a.tag,"{reason}":i})]})}yield PunishModel_1.default.updateOne({guildId:e.guildId},{$set:{bans:r}});const n=yield e.guild.members.unban(d.userId,`${e.user.tag} : ${i}`).catch((a=>{e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanRemovalFailedEmbed,{"{error}":a.message.replace("Unknown Ban","The ban has already been removed")})]})}));if(!n)return;e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BanRemovalSuccessfullyEmbed,{"{member-id}":d.userId,"{member-tag}":n.tag,"{reason}":i})]})}if("list"===m){const i=(null==t?void 0:t.id)?l.filter((e=>(null==e?void 0:e.userId)===t.id)):l;if(!i.length)return e.reply({embeds:[(0,replaceAll_1.default)(s.messages.Embeds.BansNoFoundEmbed,{"{members}":(null==t?void 0:t.id)?t.tag:"All members"})]});const o=[];for(let m=0;m<i.length;m++){const u=i[m],p=(0,replaceAll_1.default)(s.messages.Strings.BanRemovedMessage,{"{reason}":u.removeReason});o.push((0,replaceAll_1.default)(s.messages.Embeds.BannListEmbed,{"{name}":(null==t?void 0:t.tag)||e.guild.name,"{case}":u.caseNumber,"{reason-remove}":u.removeReason?p:"","{user}":null!==(d=null===(a=e.guild.members.cache.get(u.userId))||void 0===a?void 0:a.user.tag)&&void 0!==d?d:`<@!${u.userId}>`,"{time-d}":`<t:${Math.floor(u.date.getTime()/1e3)}>`,"{time-r}":`<t:${Math.floor(u.date.getTime()/1e3)}:R>`,"{reason}":u.reason,"{moderator}":null!==(n=null===(r=e.guild.members.cache.get(u.moderator))||void 0===r?void 0:r.user.tag)&&void 0!==n?n:`<@!${u.moderator}>`,"{current-page}":m+1,"{total-pages}":l.length}))}(0,pagination_1.default)({interaction:e,embeds:o,time:12e4})}}))});