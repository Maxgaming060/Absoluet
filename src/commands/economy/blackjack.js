"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),generateBlacjackBoard_1=tslib_1.__importDefault(require("../../helpers/images/generateBlacjackBoard")),messageUtils_1=require("../../helpers/messageUtils"),querys_1=require("../../helpers/querys"),Command_1=require("../../structures/Command"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),parseStyle_1=tslib_1.__importDefault(require("../../helpers/parseStyle")),__1=require("../.."),imageQuery={extension:"png",forceStatic:!0},defaultCard={suit:"??",path:"back-card.png",rank:{name:"??",value:0}},suits=["spades","hearts","diamonds","clubs"],ranks=[{name:"ace",value:1},{name:"2",value:2},{name:"3",value:3},{name:"4",value:4},{name:"5",value:5},{name:"6",value:6},{name:"7",value:7},{name:"8",value:8},{name:"9",value:9},{name:"10",value:10},{name:"jack",value:10},{name:"queen",value:10},{name:"king",value:10}];function generateDeck(){const e=[];for(const a of suits)for(const t of ranks)e.push({suit:a,rank:t,path:`${t.name}_of_${a}.png`});return shuffleDeck(e),e}function shuffleDeck(e){for(let a=e.length-1;a>0;a--){const t=Math.floor(Math.random()*(a+1));[e[a],e[t]]=[e[t],e[a]]}}function drawCard(e){return e.pop()}function getHandValue(e){let a=0,t=!1;for(const n of e)a+=n.rank.value,"ace"===n.rank.name&&(t=!0);return t&&a<=11&&(a+=10),a}function generateActionButtons(e=!1){return[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.BlackJackHit.Style)).setLabel(__1.client.messages.Buttons.BlackJackHit.Label).setDisabled(e).setCustomId("hit"),(new discord_js_1.ButtonBuilder).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.BlackJackStand.Style)).setLabel(__1.client.messages.Buttons.BlackJackStand.Label).setDisabled(e).setCustomId("stand"))]}exports.default=new Command_1.Command({name:"blackjack",description:"Play a game of Blackjack",options:[{name:"amount",description:"The amount of money you want to bet",type:discord_js_1.ApplicationCommandOptionType.Integer,required:!0,minValue:0}],run:({client:e,interaction:a})=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){const t=generateDeck(),n=a.options.getInteger("amount"),r=[drawCard(t),drawCard(t)],s=[drawCard(t),drawCard(t)],{BlackJackYouWinDescription:l,BlackJackYouWinBImageTitle:i,BlackJackYouWinImageTitle:o,BlackJackYouLoseDescription:d,BlackJackYouLoseImageTitle:u,BlackJackTieDescription:c,BlackJackTieImageTitle:m,BlackJackYouBustDescription:p,BlackJackYouBustImageTitle:g}=e.messages.Strings,y=yield(0,querys_1.guilds)().get(a.guildId),_=yield(0,querys_1.users)().economy().get({userId:a.user.id,guildId:a.guildId});if(!(0,messageUtils_1.userHaveMoney)({user:_,from:"money",interaction:a,amount:n}))return;const f=yield(0,generateBlacjackBoard_1.default)({playerHand:r,playerName:a.user.username,dealerHand:[s[0],defaultCard],dealerImage:e.user.displayAvatarURL(imageQuery),playerImage:a.user.displayAvatarURL(imageQuery)}),k=new discord_js_1.EmbedBuilder((0,replaceAll_1.default)(e.messages.Embeds.BlackJackBoardEmbed));yield a.reply({embeds:[k],components:generateActionButtons(),files:[f]});const B=a.channel.createMessageComponentCollector({filter:e=>e.user.id===a.user.id,componentType:discord_js_1.ComponentType.Button,time:6e4});B.on("collect",(f=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){const v=f.customId;if("hit"!==v){if("stand"===v){for(;getHandValue(s)<17;){const e=drawCard(t);s.push(e)}let p="";const g=getHandValue(r),v=getHandValue(s);if(v>21||g>v){const e=n*y.economyConfig.blackjackReward;k.data.description=(0,replaceAll_1.default)(l,{"{amount}":e,"{coin}":y.economyConfig.coin}),_.balance.money+=e,p=(0,replaceAll_1.default)(v>21?i:o,{"{user-name}":a.user.username})}else g<v?(k.data.description=(0,replaceAll_1.default)(d,{"{amount}":n,"{coin}":y.economyConfig.coin}),_.balance.money-=n,p=u):(k.data.description=c,p=m);const b=yield(0,generateBlacjackBoard_1.default)({playerHand:r,dealerHand:s,playerName:a.user.username,dealerImage:e.user.displayAvatarURL(),playerImage:a.user.displayAvatarURL(imageQuery),isFinished:!0,title:p});return yield f.update({embeds:[k],components:generateActionButtons(!0),files:[b]}),B.stop()}}else{let l="";const i=drawCard(t);if(r.push(i),getHandValue(r)>21){k.data.description=(0,replaceAll_1.default)(p,{"{amount}":n,"{coin}":y.economyConfig.coin}),l=(0,replaceAll_1.default)(g,{"{user-name}":a.user.username}),_.balance.money-=n;const t=yield(0,generateBlacjackBoard_1.default)({playerHand:r,dealerHand:s,playerName:a.user.username,dealerImage:e.user.displayAvatarURL(imageQuery),playerImage:a.user.displayAvatarURL(imageQuery),isFinished:!0,title:l});return yield f.update({embeds:[k],components:generateActionButtons(!0),files:[t]}),B.stop()}const o=yield(0,generateBlacjackBoard_1.default)({playerHand:r,playerName:a.user.username,dealerHand:[s[0],defaultCard],dealerImage:e.user.displayAvatarURL(imageQuery),playerImage:a.user.displayAvatarURL(imageQuery)});yield f.update({embeds:[k],files:[o]})}})))),B.on("end",((t,n)=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){yield _.save(),"time"===n&&a.editReply({embeds:[(0,replaceAll_1.default)(e.messages.Embeds.BlackJackTimeoutEmbed)],components:generateActionButtons(!0)})}))))}))});