"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),Command_1=require("../../structures/Command"),messageUtils_1=require("../../helpers/messageUtils"),BOARD_SIZE=7,BOARD_HEIGHT=6,EMPTY_CELL="‚ö™",PLAYER_1="üî¥",PLAYER_2="üü°";function createEmptyBoard(){return Array.from({length:6},(()=>Array(7).fill("‚ö™")))}function getBoardAsString(e){return`${e.map((e=>e.join(""))).join("\n")}\n1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£`}function generateComponentsBoard(e=!1){const t=[];for(let n=0;n<7;n++)t.push((new discord_js_1.ButtonBuilder).setEmoji(getEmojiForColumn(n)).setCustomId(`connect4-${n}`).setStyle(discord_js_1.ButtonStyle.Primary).setDisabled(e));const n=[];for(let e=0;e<t.length;e+=5){const o=(new discord_js_1.ActionRowBuilder).addComponents(...t.slice(e,e+5));n.push(o)}return n}function getEmojiForColumn(e){return 0===e?"1Ô∏è‚É£":1===e?"2Ô∏è‚É£":2===e?"3Ô∏è‚É£":3===e?"4Ô∏è‚É£":4===e?"5Ô∏è‚É£":5===e?"6Ô∏è‚É£":6===e?"7Ô∏è‚É£":""}function isColumnFull(e,t){return"‚ö™"!==e[0][t]}function dropDisc(e,t,n){for(let o=5;o>=0;o--)if("‚ö™"===e[o][t])return e[o][t]=n,o}function checkWin(e,t,n){const o=e[t][n];let r=1,s=t-1;for(;s>=0&&e[s][n]===o;)r++,s--;for(s=t+1;s<6&&e[s][n]===o;)r++,s++;if(r>=4)return!0;r=1;let i=n-1;for(;i>=0&&e[t][i]===o;)r++,i--;for(i=n+1;i<7&&e[t][i]===o;)r++,i++;if(r>=4)return!0;for(r=1,s=t-1,i=n+1;s>=0&&i<7&&e[s][i]===o;)r++,s--,i++;for(s=t+1,i=n-1;s<6&&i>=0&&e[s][i]===o;)r++,s++,i--;if(r>=4)return!0;for(r=1,s=t-1,i=n-1;s>=0&&i>=0&&e[s][i]===o;)r++,s--,i--;for(s=t+1,i=n+1;s<6&&i<7&&e[s][i]===o;)r++,s++,i++;return r>=4}function checkDraw(e){for(let t=0;t<6;t++)for(let n=0;n<7;n++)if("‚ö™"===e[t][n])return!1;return!0}function getPlayerDisc(e,t){return t===e.user.id?"üî¥":"üü°"}exports.default=new Command_1.Command({name:"connect4",description:"Play a game of Connect 4 with your friends",options:[{name:"user",description:"The user to play Connect 4 with",type:discord_js_1.ApplicationCommandOptionType.User,required:!0}],run:({client:e,interaction:t})=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){const n=t.options.getUser("user"),o=yield(0,messageUtils_1.approve)({author:t.user,game:"Connect 4",interaction:t,user:n});if(!o)return t.editReply({embeds:[(new discord_js_1.EmbedBuilder).setTitle(`The game has been rejected by ${n.username}`).setColor("Red")],components:[]});const r=createEmptyBoard();let s=t.user,i=!1;yield o.deferUpdate();const d=(yield t.editReply({content:`It's ${s.toString()}'s turn`,embeds:[(new discord_js_1.EmbedBuilder).setTitle("Connect 4").setDescription(getBoardAsString(r)).addFields({name:"Status",value:`${getPlayerDisc(t,s.id)} | It's ${s.toString()}'s turn`}).setColor(e.config.GeneralSettings.EmbedColor)],components:generateComponentsBoard()})).createMessageComponentCollector({componentType:discord_js_1.ComponentType.Button,time:6e4});d.on("collect",(o=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){d.resetTimer();const{customId:a}=o;if(o.user.id!==s.id)return void o.reply({content:"‚ùå You are not allowed to make a move in this turn.",ephemeral:!0});if(i)return void o.reply({content:"‚ùå The game is already over.",ephemeral:!0});const l=parseInt(a.split("connect4-")[1]);if(isNaN(l)||l<0||l>=7)return void o.reply({content:"‚ùå Invalid move. Please select a valid column.",ephemeral:!0});if(isColumnFull(r,l))return void o.reply({content:"‚ùå The selected column is already full. Please choose another column.",ephemeral:!0});const c=dropDisc(r,l,s.id===t.user.id?"üî¥":"üü°");return checkWin(r,c,l)?(i=!0,yield o.update({content:`üéâ ${s.toString()} wins!`,embeds:[(new discord_js_1.EmbedBuilder).setTitle("Connect 4").setDescription(getBoardAsString(r)).addFields({name:"Status",value:`${getPlayerDisc(t,s.id)} | ${s.toString()} won the Connect 4 Game`}).setColor(e.config.GeneralSettings.EmbedColor)],components:generateComponentsBoard(!0)}),d.stop()):checkDraw(r)?(i=!0,yield o.update({content:"It's a draw!",embeds:[(new discord_js_1.EmbedBuilder).setTitle("Connect 4").setDescription(getBoardAsString(r)).addFields({name:"Status",value:"The Game tied! No one won the Game!"}).setColor(e.config.GeneralSettings.EmbedColor)],components:generateComponentsBoard(!0)}),d.stop()):(s=s.id===t.user.id?n:t.user,void(yield o.update({content:`It's ${s.toString()}'s turn`,embeds:[(new discord_js_1.EmbedBuilder).setTitle("Connect 4").setDescription(getBoardAsString(r)).addFields({name:"Status",value:`${getPlayerDisc(t,s.id)} | It's ${s.toString()}'s turn`}).setColor(e.config.GeneralSettings.EmbedColor)],components:generateComponentsBoard()})))})))),d.on("end",(()=>{i||t.editReply({content:"The game has ended due to inactivity.",embeds:[(new discord_js_1.EmbedBuilder).setTitle("Connect 4").setDescription(getBoardAsString(r)).setColor(e.config.GeneralSettings.EmbedColor)],components:generateComponentsBoard(!0)})}))}))});
