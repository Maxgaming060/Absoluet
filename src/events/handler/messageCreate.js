"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),querys_1=require("../../helpers/querys"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),Event_1=require("../../structures/Event"),__1=require("../.."),defaultEmojis={tickets:"🎫",general:"📚",music:"🎧",moderation:"🔒",admin:"🕵️‍♀️",fun:"🥳",economy:"💰"};function updateUserData(e,t,s,i){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const n=yield(0,querys_1.users)().profile().get({guildId:s,userId:t}),l=Math.floor(Math.random()*(e.levelsConfig.max-e.levelsConfig.min)+e.levelsConfig.min);n.xp+=l;const o=n.level,r=Math.floor(.1*Math.sqrt(n.xp));if(n.level=r,n.messages+=1,r>o){const t=__1.client.channels.cache.get(e.levelUpChannel);t&&t instanceof discord_js_1.TextChannel&&(yield t.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.LevelUpEmbed,{"{user-tag}":i.author.tag,"{user-id}":i.author.id,"{user-level}":r})]}))}return yield n.save()}))}function checkFilters(e,t){var s,i;return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(t.channel.type!==discord_js_1.ChannelType.GuildText)return;if(t.member.roles.cache.some((t=>e.filtersConfig.bypassRoles.includes(t.id))))return;if(e.filtersConfig.inTickets&&t.channel.name.startsWith("ticket-"))return;const n=t.cleanContent.split(" "),l=/(https?:\/\/|http?:\/\/)?(www.)?(discord.(gg|io|me|li)|discordapp.com\/invite|discord.com\/invite)\/[^\s\/]+?(?=\b)/gm;for(const i of n)if(l.test(i)&&(null===(s=null==e?void 0:e.filtersConfig)||void 0===s?void 0:s.invites)){yield t.delete();const e=yield t.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.MessageWithInviteBlocked,{"{user-tag}":t.author.tag,"{user-id}":t.author.id})]});return void setTimeout((()=>e.delete().catch((e=>e))),5e3)}const o=/^(https?:\/\/)?(www\.)?[a-zA-Z0-9]+\.[a-zA-Z]{2,}(\/\S*)*$/gm;for(const s of n)if(o.test(s)&&(null===(i=null==e?void 0:e.filtersConfig)||void 0===i?void 0:i.links)){yield t.delete();const e=yield t.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.MessageWithLinkBlocked,{"{user-tag}":t.author.tag,"{user-id}":t.author.id})]});setTimeout((()=>e.delete().catch((e=>e))),5e3)}}))}function checkUserAFK(e){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const t=yield(0,querys_1.users)().profile().get({guildId:e.guildId,userId:e.author.id});if(t.afk.status){t.afk.status=!1,t.afk.reason="",yield t.save();const s=yield e.reply({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.AfkDetectedEmbed,{"{user-tag}":e.author.tag,"{user-username}":e.author.username,"{user-id}":e.author.id})]});return setInterval((()=>s.delete().catch((e=>e))),5e3)}const s=e.mentions.users;for(const t of s.toJSON()){const s=yield(0,querys_1.users)().profile().get({guildId:e.guildId,userId:t.id});if(s.afk.status){const i=yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.AfkPingEmbed,{"{user-tag}":t.tag,"{user-username}":t.username,"{user-pfp}":t.displayAvatarURL(),"{user-id}":t.id,"{reason}":s.afk.reason,"{time}":Math.floor(s.afk.since/1e3)})]});return setInterval((()=>i.delete().catch((e=>e))),5e3)}}}))}function sendHelpEmbed(e){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const t={},s=__1.client.commands.toJSON(),i=(e="")=>{const s=[];let i=new discord_js_1.ActionRowBuilder;for(const n of Object.keys(t)){const t=e===n||"all"===e,l=n===e||"all"===e?discord_js_1.ButtonStyle.Danger:discord_js_1.ButtonStyle.Secondary;i.addComponents((new discord_js_1.ButtonBuilder).setLabel(n[0].toUpperCase()+n.slice(1)).setCustomId(`${n}`).setEmoji(defaultEmojis[n]||"🔍").setStyle(l).setDisabled(t)),5===i.components.length&&(s.push(i),i=new discord_js_1.ActionRowBuilder)}return i.components.length>0&&s.push(i),s};for(const e of s)t[e.directory]||(t[e.directory]=[]),t[e.directory].push(e);const n=yield e.reply({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.HelpMainEmbed,{"{total-commands}":s.length})],components:i()}),l=n.createMessageComponentCollector({filter:t=>t.user.id===e.author.id||(t.reply({content:":x: | You cannot interact with this command.",ephemeral:!0}),!1),componentType:discord_js_1.ComponentType.Button,time:6e4});l.on("collect",(e=>tslib_1.__awaiter(this,void 0,void 0,(function*(){yield e.deferUpdate();const s=e.customId,n=`\`${defaultEmojis[s]||"🔍"}\``;l.resetTimer();const o=t[s].map((e=>(0,replaceAll_1.default)(__1.client.messages.Strings.HelpCommandName,{"{name}":e.name})));yield e.editReply({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.HelpCategoryEmbed,{"{emoji}":n,"{name}":s[0].toUpperCase()+s.slice(1),"{commands}":o.join(__1.client.messages.Strings.HelpCommandJoin)})],components:i(s)})})))),l.on("end",(()=>{n.edit({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.HelpTimeOutEmbed)],components:i("all")})}))}))}exports.default=new Event_1.Event("messageCreate",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){if(e.author.bot||!e.guildId)return;const t=yield(0,querys_1.guilds)().get(e.guildId);return yield checkUserAFK(e),yield checkFilters(t,e),yield updateUserData(t,e.author.id,e.guildId,e),e.mentions.users.has(__1.client.user.id)&&!e.reference?yield sendHelpEmbed(e):void 0}))));