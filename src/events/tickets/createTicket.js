"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),TicketModel_1=tslib_1.__importDefault(require("../../models/TicketModel")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),parseStyle_1=tslib_1.__importDefault(require("../../helpers/parseStyle")),GuildModel_1=tslib_1.__importDefault(require("../../models/GuildModel")),Event_1=require("../../structures/Event"),querys_1=require("../../helpers/querys"),__1=require("../..");function updateTicketNumber(e){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const t=yield GuildModel_1.default.findOneAndUpdate({guildId:e},{$inc:{"ticketConfig.ticketCounter":1}});return String(t.ticketConfig.ticketCounter+1).padStart(4,"0")}))}exports.default=new Event_1.Event("interactionCreate",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var t,s,i;let l=null,n=!1;if(e.isButton()?(l=e.customId.split("tkt-")[1],n=e.customId.startsWith("tkt-")):e.isStringSelectMenu()&&(n=e.customId.startsWith("tkt-"),l=e.values[0]),!e.isButton()&&!e.isStringSelectMenu())return;if(!n)return;const d=yield(0,querys_1.guilds)().get(e.guildId);if(!(null===(s=null===(t=null==d?void 0:d.ticketConfig)||void 0===t?void 0:t.panels)||void 0===s?void 0:s.length))return;const{ticketConfig:o}=d,r=o.panels.find((e=>e.customId===l));if((yield TicketModel_1.default.find({ownerId:e.user.id})).length>=d.ticketConfig.maxTickets)return e.reply({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.UserMaxTicketsOpened,{"{max}":d.ticketConfig.maxTickets})],ephemeral:!0});const a={};let u;if(null===(i=null==r?void 0:r.questions)||void 0===i?void 0:i.length){const{questions:C}=r,k=5,S=[];for(let T=0;T<C.length;T+=k){const j=C.slice(T,T+k);S.push(j)}const v=Date.now().toString();function w(e,t,s={}){var i;return tslib_1.__awaiter(this,void 0,void 0,(function*(){if(e>=S.length)return u=t;const l=S[e],n=(new discord_js_1.ModalBuilder).setTitle(`${r.name} Form ${S.length>1?`[${e+1}]`:""}`).setCustomId(`${v}-${e}`).setComponents(l.map((({name:e,type:t,required:i,description:l})=>(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.TextInputBuilder).setCustomId(e).setPlaceholder(l||"").setValue(s[e]||"").setMaxLength(1024).setLabel(e).setStyle(t).setRequired(i)))));yield t.showModal(n);const d=yield t.awaitModalSubmit({time:6e5,filter:s=>s.user.id===t.user.id&&s.customId===`${v}-${e}`});if(!d)return;u=d;const o=[],c={};for(const e of l){const t=d.fields.getTextInputValue(e.name),s=__1.client.messages.Strings.TicketQuestionNull;t&&e.regex&&!(null===(i=e.regex)||void 0===i?void 0:i.test(t))&&o.push(e.name),a[e.name]=t||s,c[e.name]=t||s}const m=yield d.reply(Object.assign({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setCustomId("confirm").setLabel(__1.client.messages.Buttons.ConfirmQuestion.Label).setEmoji(__1.client.messages.Buttons.ConfirmQuestion.Emoji).setDisabled(o.length>0).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.ConfirmQuestion.Style)),(new discord_js_1.ButtonBuilder).setCustomId("edit").setLabel(__1.client.messages.Buttons.EditQuestion.Label).setEmoji(__1.client.messages.Buttons.EditQuestion.Emoji).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.EditQuestion.Style)))],ephemeral:!0},o.length>0?{content:(0,replaceAll_1.default)(__1.client.messages.Strings.TicketModalRegexError,{"{values}":o.map((e=>(0,replaceAll_1.default)(__1.client.messages.Strings.TicketModalRegexErrorValue,{"{name}":e}))).join("")})}:{})),_=yield m.awaitMessageComponent({filter:e=>e.user.id===t.user.id,componentType:discord_js_1.ComponentType.Button});return yield m.delete().catch((e=>e)),"confirm"===_.customId?yield w(e+1,_):yield w(e,_,c)}))}yield w(0,e)}const c=[{id:e.guildId,deny:["ViewChannel"]},{id:e.user.id,allow:["ViewChannel","SendMessages","AddReactions","AttachFiles","EmbedLinks"]},...r.roles.filter((t=>e.guild.roles.cache.has(t))).map((e=>({id:e,allow:["ViewChannel","SendMessages","AddReactions","AttachFiles","EmbedLinks"]})))],m=yield updateTicketNumber(e.guildId),_=yield e.guild.channels.create({name:(0,replaceAll_1.default)(__1.client.messages.Strings.TicketChannelName,{"{counter}":m,"{member-id}":e.user.id,"{member-tag}":e.user.tag,"{member-username}":e.user.username,"{panel-emoji}":r.emoji}),type:discord_js_1.ChannelType.GuildText,permissionOverwrites:c,parent:r.category}),{OpenedTicketEmbed:p,OpenedTicketWithQuestionsEmbed:g}=__1.client.messages.Embeds,f=(0,replaceAll_1.default)(u?g:p,{"{guild-name}":e.guild.name,"{owner}":e.user.toString(),"{emoji}":r.emoji,"{panel}":r.name});u&&(f.fields=Object.entries(a).map((([e,t])=>({name:e,value:t,inline:!0}))),5===f.fields.length&&f.fields.push({name:"ㅤ",value:"ㅤ",inline:!0}));const y=yield _.send({embeds:[f],content:f.content,components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClose.Emoji).setLabel(__1.client.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClose.Style)).setCustomId("tka-close"),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClaim.Emoji).setLabel(__1.client.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim"))]});yield y.pin(),_.bulkDelete(1);const h={embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.UserCreatedTicketEmbed,{"{channel}":_.toString()})],ephemeral:!0};u?yield u.reply(h).catch((e=>e)):yield e.reply(h).catch((e=>e));const b=new TicketModel_1.default({channelId:_.id,channelName:_.name,guildId:e.guildId,isClaimed:!1,isClosed:!1,messageControl:null,ownerId:e.user.id,panel:r.name,parentId:r.category,staffClaimed:null,staffRoles:r.roles,usersInTicket:[e.user.id]});yield b.save()}))));
