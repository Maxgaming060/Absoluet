"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),discord_html_transcripts_1=require("discord-html-transcripts"),TicketModel_1=tslib_1.__importDefault(require("../../models/TicketModel")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),parseStyle_1=tslib_1.__importDefault(require("../../helpers/parseStyle")),Event_1=require("../../structures/Event"),querys_1=require("../../helpers/querys"),__1=require("../..");exports.default=new Event_1.Event("interactionCreate",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var t,s,i,l,n,a;if(!e.isButton())return;if(!e.customId.startsWith("tka-"))return;if(e.channel.type!==discord_js_1.ChannelType.GuildText)return;const d=e.customId.split("tka-")[1],r=yield TicketModel_1.default.findOne({channelId:e.channelId});if(null==r?void 0:r.ownerId){if("close"===d){if(yield e.deferUpdate(),r.isClosed)return e.followUp({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketAlreadyClosed)]});for(const t of r.usersInTicket)yield e.channel.permissionOverwrites.edit(t,{ViewChannel:!1}).catch((e=>e));yield e.editReply({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClose.Emoji).setLabel(__1.client.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClose.Style)).setCustomId("tka-close").setDisabled(!0),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClaim.Emoji).setLabel(__1.client.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim").setDisabled(r.isClaimed))]});const t=yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketClosedEmbed,{"{user}":e.user.toString(),"{user-id}":e.user.id,"{user-tag}":e.user.tag})],components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketTranscript.Emoji).setLabel(__1.client.messages.Buttons.TicketTranscript.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketTranscript.Style)).setCustomId("tka-transcript"),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketOpen.Emoji).setLabel(__1.client.messages.Buttons.TicketOpen.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketOpen.Style)).setCustomId("tka-open"),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketDelete.Emoji).setLabel(__1.client.messages.Buttons.TicketDelete.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketDelete.Style)).setCustomId("tka-delete"))]});return r.messageControl=t.id,r.isClosed=!0,yield r.save()}if("claim"===d){yield e.deferUpdate();const i=null===(t=__1.client.commandsConfig.Claim)||void 0===t?void 0:t.Permissions;if(!e.guild.members.cache.get(e.user.id).roles.cache.some((e=>i.includes(e.id)||i.includes(e.name))))return e.followUp({embeds:[(new discord_js_1.EmbedBuilder).setTitle("You don't have permissions to execute this command").setColor("Red")],ephemeral:!0});if(r.isClaimed)return e.followUp({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketAlreadyClaimed,{"{user-tag}":(null===(s=__1.client.users.cache.get(r.staffClaimed))||void 0===s?void 0:s.tag)||"Unknown#000"})],ephemeral:!0});yield e.channel.permissionOverwrites.edit(e.user.id,{ViewChannel:!0,ManageChannels:!0});for(const t of r.staffRoles)yield e.channel.permissionOverwrites.edit(t,{ViewChannel:!1}).catch((e=>e));return r.isClaimed=!0,r.staffClaimed=e.user.id,yield r.save(),yield e.editReply({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClose.Emoji).setLabel(__1.client.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClose.Style)).setCustomId("tka-close").setDisabled(r.isClosed),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClaim.Emoji).setLabel(__1.client.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim").setDisabled(r.isClaimed))]}),e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketClaimedEmbed,{"{user}":e.user.toString(),"{user-id}":e.user.id,"{user-tag}":e.user.tag})]})}if("delete"===d){if(yield e.deferUpdate(),!r.isClosed)return e.followUp({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketIsNotClosed)]});const t=yield(0,querys_1.guilds)().get(e.guildId);if(null===(i=t.ticketConfig)||void 0===i?void 0:i.autoSaveTranscript){const s=e.guild.channels.cache.get((null===(l=t.ticketConfig)||void 0===l?void 0:l.transcriptChannel)||""),i="user"===(null===(n=t.ticketConfig)||void 0===n?void 0:n.transcriptType),a=yield(0,discord_html_transcripts_1.createTranscript)(e.channel,{poweredBy:!1,filename:`transcript-${e.channel.name}.html`,limit:-1});if(!s)return e.followUp({embeds:[(new discord_js_1.EmbedBuilder).setTitle("Configure the transcript channel using -/setup").setColor(__1.client.config.GeneralSettings.EmbedColor)],ephemeral:!0});const d=__1.client.users.cache.get(r.ownerId);if(s.type!==discord_js_1.ChannelType.GuildText)return;const c=yield s.send({files:[a],embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptEmbed,{"{user-tag}":d.tag,"{user-pfp}":d.displayAvatarURL(),"{user}":d.toString(),"{ticket-name}":e.channel.name,"{panel-name}":r.panel,"{transcript-url}":"Loading...","{staff-tag}":e.user.tag})]}),o={embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptEmbed,{"{user-tag}":d.tag,"{user-pfp}":d.displayAvatarURL(),"{user}":d.toString(),"{ticket-name}":e.channel.name,"{panel-name}":r.panel,"{transcript-url}":c.attachments.first().url,"{staff-tag}":e.user.tag})]};yield c.edit(o),i&&(yield d.send(o).catch((e=>e))),yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptSaved)]})}yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketWillBeClosed)]});const s=e.guild.members.cache.get(r.ownerId);return __1.client.emit("guildTicketDeleted",s,r),setTimeout((()=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){yield e.channel.delete(),yield r.deleteOne()}))),5e3)}if("open"===d){if(yield e.deferUpdate(),!r.isClosed)return yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketIsNotClosed)]});for(const t of r.usersInTicket)yield e.channel.permissionOverwrites.edit(t,{ViewChannel:!0}).catch((e=>e));yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketOpenedEmbed,{"{user-tag}":e.user.tag})]}),yield e.message.delete(),r.isClosed=!1,yield r.save();return(yield e.channel.messages.fetchPinned()).first().edit({components:[(new discord_js_1.ActionRowBuilder).addComponents((new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClose.Emoji).setLabel(__1.client.messages.Buttons.TicketClose.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClose.Style)).setCustomId("tka-close").setDisabled(!1),(new discord_js_1.ButtonBuilder).setEmoji(__1.client.messages.Buttons.TicketClaim.Emoji).setLabel(__1.client.messages.Buttons.TicketClaim.Label).setStyle((0,parseStyle_1.default)(__1.client.messages.Buttons.TicketClaim.Style)).setCustomId("tka-claim").setDisabled(r.isClaimed))]})}if("transcript"===d){yield e.deferUpdate();const t=yield(0,querys_1.guilds)().get(e.guildId),s=e.guild.channels.cache.get((null===(a=t.ticketConfig)||void 0===a?void 0:a.transcriptChannel)||"");if(!s)return e.followUp({embeds:[(new discord_js_1.EmbedBuilder).setTitle("Configure the transcript channel using -/setup").setColor(__1.client.config.GeneralSettings.EmbedColor)],ephemeral:!0});const i=yield(0,discord_html_transcripts_1.createTranscript)(e.channel,{poweredBy:!1,filename:`transcript-${e.channel.name}.html`,limit:-1}),l=__1.client.users.cache.get(r.ownerId);if(s.type!==discord_js_1.ChannelType.GuildText)return;const n=yield s.send({files:[i],embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptEmbed,{"{user-tag}":l.tag,"{user-pfp}":l.displayAvatarURL(),"{user}":l.toString(),"{ticket-name}":e.channel.name,"{panel-name}":r.panel,"{transcript-url}":"Loading...","{staff-tag}":e.user.tag})]});yield n.edit({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptEmbed,{"{user-tag}":l.tag,"{user-pfp}":l.displayAvatarURL(),"{user}":l.toString(),"{ticket-name}":e.channel.name,"{panel-name}":r.panel,"{transcript-url}":n.attachments.first().url,"{staff-tag}":e.user.tag})]}),yield e.channel.send({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.TicketTranscriptSaved)]})}}}))));