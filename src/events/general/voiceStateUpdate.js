"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),messageUtils_1=require("../../helpers/messageUtils"),VoiceChannelModel_1=tslib_1.__importDefault(require("../../models/VoiceChannelModel")),discord_js_1=require("discord.js"),querys_1=require("../../helpers/querys"),Event_1=require("../../structures/Event"),__1=require("../..");function voiceMemberAdd(e){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const i=e.member,n=yield(0,querys_1.guilds)().get(e.guild.id);if(e.channelId===n.generatorChannel){const{parentId:d}=e.guild.channels.cache.get(n.generatorChannel),t=yield e.guild.channels.create({name:`${i.user.username}'s VC`,type:discord_js_1.ChannelType.GuildVoice,parent:d});yield VoiceChannelModel_1.default.create({ownerId:i.id,channelId:t.id,guildId:e.guild.id}),yield t.send((0,messageUtils_1.generateInterfaceEmbed)(__1.client)),yield i.voice.setChannel(t).catch((e=>e))}}))}function voiceMemberRemove(e){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const i=yield VoiceChannelModel_1.default.findOne({guildId:e.guild.id,channelId:e.channelId});i&&e.channel.members.size<=0&&(yield i.deleteOne(),yield e.channel.delete())}))}exports.default=new Event_1.Event("voiceStateUpdate",((e,i)=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var n;e.channelId!==i.channelId&&voiceMemberRemove(e),(null===(n=i.channel)||void 0===n?void 0:n.id)&&voiceMemberAdd(i);const d=i.member.id,t=i.guild.id,l=__1.client.voiceTimer.get(d);if(i.channel&&!l&&__1.client.voiceTimer.set(d,{guildId:t,start:Date.now()}),e.channelId&&!i.channelId){const e=yield(0,querys_1.users)().profile().get({guildId:t,userId:d}),i=Date.now()-l.start;__1.client.voiceTimer.delete(d),yield e.updateOne({$inc:{voiceTime:i}})}}))));