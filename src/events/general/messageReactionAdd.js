"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),querys_1=require("../../helpers/querys"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),Event_1=require("../../structures/Event"),__1=require("../.."),pollEmojis=["1Ô∏è‚É£","2Ô∏è‚É£","3Ô∏è‚É£","4Ô∏è‚É£","5Ô∏è‚É£","6Ô∏è‚É£","7Ô∏è‚É£","8Ô∏è‚É£","9Ô∏è‚É£","üîü"],starboardEmoji="‚≠ê";function managePollReaction(e,t){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const s=e.message;if(s.reactions.cache.size<2)return;const i=yield(0,querys_1.polls)().get(s.id,s.channelId,s.guildId);if(!i)return;const a=yield t.fetch();if("single"===i.pollType&&i.voters.some((e=>e.userId===a.id)))return yield e.users.remove(a);i.voters.push({value:pollEmojis.indexOf(e.emoji.name)+1,userId:a.id}),yield i.updateOne({$set:{voters:i.voters}});const r=__1.client.users.cache.get(i.authorId),l=i.choices.map(((e,t)=>{const s=i.voters.filter((e=>e.value===t+1)).length;return(0,replaceAll_1.default)(__1.client.messages.Embeds.PollEmbed.choicesFormat,{"{emoji}":pollEmojis[t],"{choice}":e,"{percentage}":`${(s/i.voters.length*100||0).toFixed(2)}`,"{votes}":s})}));yield s.edit({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.PollEmbed,{"{title}":i.title,"{description}":i.description,"{choices}":l.join(""),"{author-username}":r.username,"{author-pfp}":r.displayAvatarURL(),"{author-tag}":r.tag,"{timestamp}":(new Date).toISOString(),"{votes-total}":i.voters.length,"{mode}":capitalize(i.pollType)})]})}))}function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}exports.default=new Event_1.Event("messageReactionAdd",((e,t)=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){const s=e.message;if(s.author.id!==t.id&&!s.author.bot){if(pollEmojis.includes(e.emoji.name))return yield managePollReaction(e,t);if("‚≠ê"===e.emoji.name){const e=yield(0,querys_1.guilds)().get(s.guildId);if(!e.starboardConfig.enabled)return;const t=s.guild.channels.cache.get(null==e?void 0:e.starboardConfig.channel);if(!t||t.id===s.channelId)return;const i=yield(0,querys_1.starboards)().get(s.channelId,s.id),a={embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.StarboardEmbed,{"{message-url}":s.url,"{star-count}":s.reactions.cache.size,"{channel-id}":s.channelId,"{user-username}":s.author.username,"{user-pfp}":s.author.displayAvatarURL(),"{message-content}":s.content,"{message-id}":s.id,"{message-timestamp}":s.createdAt.toISOString()})],content:(0,replaceAll_1.default)(__1.client.messages.Embeds.StarboardEmbed.content,{"{star-count}":s.reactions.cache.size,"{channel-id}":s.channelId})};if(i){const e=yield t.messages.fetch(i.starboardId);return yield e.edit(a)}const r=yield t.send(a);yield r.react("‚≠ê"),yield(0,querys_1.starboards)().create({guildId:s.guildId,channelId:s.channelId,messageId:s.id,starboardId:r.id,authorId:s.author.id})}}}))));