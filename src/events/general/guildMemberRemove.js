"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),InvitesModel_1=tslib_1.__importDefault(require("../../models/InvitesModel")),Event_1=require("../../structures/Event"),querys_1=require("../../helpers/querys"),getUser_1=tslib_1.__importDefault(require("../../helpers/getUser")),__1=require("../..");exports.default=new Event_1.Event("guildMemberRemove",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var i,l,t,d,u;e.partial&&(yield e.fetch(!0));const s=yield(0,getUser_1.default)(e.id,e.guild.id),r=yield __1.client.users.fetch(null==s?void 0:s.inviterId).catch((()=>null));if(yield s.deleteOne(),!calculateDays(e.user.createdTimestamp,7)||!e.user.bot||!r){const u=yield InvitesModel_1.default.findOne({userId:null==r?void 0:r.id,guildId:e.guild.id});null===(i=null==u?void 0:u.left)||void 0===i||i.push(e.id),(null===(l=null==u?void 0:u.invites)||void 0===l?void 0:l.includes(e.id))&&(u.invites=null===(t=null==u?void 0:u.invites)||void 0===t?void 0:t.filter((i=>i!==e.id))),u.fake.includes(e.id)&&(u.fake=null===(d=null==u?void 0:u.fake)||void 0===d?void 0:d.filter((i=>i!==e.id))),yield u.save()}const n=yield(0,querys_1.guilds)().get(e.guild.id);if(!(null===(u=null==n?void 0:n.goodbyeSettings)||void 0===u?void 0:u.channel))return;const a=n.goodbyeSettings,o=e.guild.channels.cache.get(a.channel);o&&(yield o.send((0,replaceAll_1.default)(a.message,{"{user-tag}":e.user.tag,"{user-avatar}":e.user.displayAvatarURL(),"{guild-icon}":e.guild.iconURL(),"{user-id}":e.id,"{user-name}":e.user.username,"{guild-name}":e.guild.name,"{memberCount}":e.guild.memberCount,"{createdTimestamp}":Math.floor(e.user.createdTimestamp/1e3),"{joinedTimestamp}":Math.floor(e.joinedTimestamp/1e3)})))}))));const calculateDays=(e,i)=>Date.now()-e<24*i*60*60*1e3;