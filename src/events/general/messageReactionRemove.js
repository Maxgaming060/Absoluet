"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),querys_1=require("../../helpers/querys"),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),Event_1=require("../../structures/Event"),__1=require("../.."),pollEmojis=["1Ô∏è‚É£","2Ô∏è‚É£","3Ô∏è‚É£","4Ô∏è‚É£","5Ô∏è‚É£","6Ô∏è‚É£","7Ô∏è‚É£","8Ô∏è‚É£","9Ô∏è‚É£","üîü"],starboardEmoji="‚≠ê";function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function managePollReaction(e,t){return tslib_1.__awaiter(this,void 0,void 0,(function*(){const s=e.message;if(s.reactions.cache.size<2)return;const i=yield(0,querys_1.polls)().get(s.id,s.channelId,s.guildId);if(!i)return;const a=pollEmojis.indexOf(e.emoji.name)+1;if(!i.voters.find((e=>e.userId===t.id&&e.value===a)))return;const r=i.voters.filter((e=>e.userId!==t.id));yield i.updateOne({$set:{voters:r}});const n=__1.client.users.cache.get(i.authorId),l=i.choices.map(((e,t)=>{const s=r.filter((e=>e.value===t+1)).length;return(0,replaceAll_1.default)(__1.client.messages.Embeds.PollEmbed.choicesFormat,{"{emoji}":pollEmojis[t],"{choice}":e,"{percentage}":`${(s/r.length*100||0).toFixed(2)}`,"{votes}":s})}));yield s.edit({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.PollEmbed,{"{title}":i.title,"{description}":i.description,"{choices}":l.join(""),"{author-username}":n.username,"{author-pfp}":n.displayAvatarURL(),"{author-tag}":n.tag,"{timestamp}":(new Date).toISOString(),"{votes-total}":r.length,"{mode}":capitalize(i.pollType)})]})}))}exports.default=new Event_1.Event("messageReactionRemove",((e,t)=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){const s=e.message;if(s.author.id!==t.id&&!s.author.bot){if(pollEmojis.includes(e.emoji.name))return yield managePollReaction(e,t);if("‚≠ê"===e.emoji.name){const e=yield(0,querys_1.guilds)().get(s.guildId);if(!e.starboardConfig.enabled)return;const t=yield(0,querys_1.starboards)().get(s.channelId,s.id);if(!t)return;const i=s.guild.channels.cache.get(null==e?void 0:e.starboardConfig.channel);if(!i||i.id===s.channelId)return;const a=yield i.messages.fetch(t.starboardId);a&&(yield a.edit({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.StarboardEmbed,{"{message-url}":s.url,"{star-count}":s.reactions.cache.size,"{channel-id}":s.channelId,"{user-username}":s.author.username,"{user-pfp}":s.author.displayAvatarURL(),"{message-content}":s.content,"{message-id}":s.id,"{message-timestamp}":s.createdAt.toISOString()})],content:(0,replaceAll_1.default)(__1.client.messages.Embeds.StarboardEmbed.content,{"{star-count}":s.reactions.cache.size,"{channel-id}":s.channelId})}))}}}))));