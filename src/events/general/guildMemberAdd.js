"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),welcomeCard_1=tslib_1.__importDefault(require("../../helpers/images/welcomeCard")),getInviter_1=tslib_1.__importDefault(require("../../helpers/getInviter")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),Event_1=require("../../structures/Event"),querys_1=require("../../helpers/querys"),getUser_1=tslib_1.__importDefault(require("../../helpers/getUser")),__1=require("../..");exports.default=new Event_1.Event("guildMemberAdd",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){var i,l,t,d,n,r,u,s,o;e.partial&&(yield e.fetch(!0));const a=yield(0,getInviter_1.default)(__1.client,e),v=yield(0,querys_1.guilds)().get(e.guild.id);(null==v?void 0:v.welcomeSettings.autoRoles)&&(yield e.roles.add(null==v?void 0:v.welcomeSettings.autoRoles).catch((e=>e))),yield(0,getUser_1.default)(e.id,e.guild.id,null==a?void 0:a.inviterId);const c=yield(0,getUser_1.default)(null==a?void 0:a.inviterId,e.guild.id);if(calculateDays(e.user.createdTimestamp,7))null===(r=null==c?void 0:c.fake)||void 0===r||r.push(e.id),yield c.save();else{if(null===(i=null==c?void 0:c.invites)||void 0===i?void 0:i.includes(e.id))return;null===(l=null==c?void 0:c.join)||void 0===l||l.push(e.id),(null===(t=null==c?void 0:c.left)||void 0===t?void 0:t.includes(e.id))&&(c.left=null===(d=c.left)||void 0===d?void 0:d.filter((i=>i!==e.id))),null===(n=null==c?void 0:c.invites)||void 0===n||n.push(e.id),yield c.save()}if(!(null===(u=null==v?void 0:v.welcomeSettings)||void 0===u?void 0:u.channel))return;const m=v.welcomeSettings,_=e.guild.channels.cache.get(m.channel);if(!_)return;const g=[];if(JSON.stringify(m.message).includes("{card-url}")){const i=yield(0,welcomeCard_1.default)(e);g.push(new discord_js_1.AttachmentBuilder(i,{name:"welcome-card.jpg"}))}yield _.send(Object.assign({files:g},(0,replaceAll_1.default)(m.message,{"{user-tag}":e.user.tag,"{user-avatar}":e.user.displayAvatarURL(),"{guild-icon}":e.guild.iconURL(),"{user-id}":e.id,"{user-name}":e.user.username,"{guild-name}":e.guild.name,"{memberCount}":e.guild.memberCount,"{createdTimestamp}":Math.floor(e.user.createdTimestamp/1e3),"{joinedTimestamp}":Math.floor(e.joinedTimestamp/1e3),"{inviter-mention}":`<@!${null==a?void 0:a.inviterId}>`,"{inviter-tag}":`${(null===(s=null==a?void 0:a.inviter)||void 0===s?void 0:s.tag)||"Unknown#0001"}`,"{inviter-name}":`${(null===(o=null==a?void 0:a.inviter)||void 0===o?void 0:o.username)||"Unknown"}`,"{inviter-id}":`${(null==a?void 0:a.inviterId)||__1.client.user.id}`,"{code}":`${(null==a?void 0:a.code)||"unknown"}`,"{card-url}":"attachment://welcome-card.jpg","{invites}":c.invites.length+c.bonus})))}))));const calculateDays=(e,i)=>Date.now()-e<24*i*60*60*1e3;