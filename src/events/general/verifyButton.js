"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("tslib"),discord_js_1=require("discord.js"),generateCaptcha_1=tslib_1.__importDefault(require("../../helpers/images/generateCaptcha")),replaceAll_1=tslib_1.__importDefault(require("../../helpers/replaceAll")),Event_1=require("../../structures/Event"),querys_1=require("../../helpers/querys"),__1=require("../..");function components(e,t){return[(new discord_js_1.ActionRowBuilder).addComponents(e.map((e=>(new discord_js_1.ButtonBuilder).setLabel(e).setStyle(t?t===e?discord_js_1.ButtonStyle.Success:discord_js_1.ButtonStyle.Danger:discord_js_1.ButtonStyle.Secondary).setDisabled(Boolean(t)).setCustomId(e))))]}function otherWords(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=[e];for(let e=0;e<4;e++){let e="";for(let r=0;r<7;r++)e+=t[Math.floor(26*Math.random())];r.push(e)}for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}return r}function randomWord(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ";let t="";for(let r=0;r<7;r++)t+=e[Math.floor(26*Math.random())];return t}exports.default=new Event_1.Event("interactionCreate",(e=>tslib_1.__awaiter(void 0,void 0,void 0,(function*(){if(!e.isButton())return;if("verify"!==e.customId)return;const t=yield e.guild.members.fetch(e.user.id),r=yield(0,querys_1.guilds)().get(e.guildId),o=null==r?void 0:r.verifySettings;if(!(null==o?void 0:o.roleId))return;if(e.guild.roles.cache.get(o.roleId))if(yield e.deferReply({ephemeral:!0}),"direct"===o.type)yield t.roles.add(o.roleId).catch(console.error),yield e.followUp({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.UserVerifiedEmbed)],ephemeral:!0});else if("captcha"===o.type){const r=randomWord(),s=otherWords(r),l=yield(0,generateCaptcha_1.default)(r),d=new discord_js_1.AttachmentBuilder(l,{name:"captcha.png"}),i=yield e.followUp({embeds:[(0,replaceAll_1.default)(__1.client.messages.Embeds.VerificationCaptchaEmbed)],files:[d],components:components(s),ephemeral:!0}),n=yield i.awaitMessageComponent({filter:t=>t.user.id===e.user.id,componentType:discord_js_1.ComponentType.Button});yield n.deferUpdate(),n.customId===r&&(yield t.roles.add(o.roleId).catch(console.error)),yield n.editReply({embeds:[(0,replaceAll_1.default)(n.customId===r?__1.client.messages.Embeds.UserVerifiedEmbed:__1.client.messages.Embeds.VerificationIncorrectEmbed)],components:components(s,r)})}}))));